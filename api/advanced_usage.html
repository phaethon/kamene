<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Advanced usage &mdash; Scapy 3.0.0 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '3.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="Scapy 3.0.0 documentation" href="index.html" />
    <link rel="next" title="Build your own tools" href="extending.html" />
    <link rel="prev" title="Usage" href="usage.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="advanced-usage">
<h1>Advanced usage<a class="headerlink" href="#advanced-usage" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This section has not been updated for scapy3k yet. Code examples may not work directly. Try bytes() instead of str() and b&#8217;string&#8217; instead of b&#8217;somestring&#8217;.</p>
</div>
<div class="section" id="asn-1-and-snmp">
<h2>ASN.1 and SNMP<a class="headerlink" href="#asn-1-and-snmp" title="Permalink to this headline">¶</a></h2>
<div class="section" id="what-is-asn-1">
<h3>What is ASN.1?<a class="headerlink" href="#what-is-asn-1" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This is only my view on ASN.1, explained as simply as possible. For more theoretical or academic views, I&#8217;m sure you&#8217;ll find better on the Internet.</p>
</div>
<p>ASN.1 is a notation whose goal is to specify formats for data exchange. It is independant of the way data is encoded. Data encoding is specified in Encoding Rules.</p>
<p>The most used encoding rules are BER (Basic Encoding Rules) and DER (Distinguished Encoding Rules). Both look the same, but the latter is specified to guarantee uniqueness of encoding. This property is quite interesting when speaking about cryptography, hashes and signatures.</p>
<p>ASN.1 provides basic objects: integers, many kinds of strings, floats, booleans, containers, etc. They are grouped in the so called Universal class. A given protocol can provide other objects which will be grouped in the Context class. For example, SNMP defines PDU_GET or PDU_SET objects. There are also the Application and Private classes.</p>
<p>Each of theses objects is given a tag that will be used by the encoding rules. Tags from 1 are used for Universal class. 1 is boolean, 2 is integer, 3 is a bit string, 6 is an OID, 48 is for a sequence. Tags from the <code class="docutils literal"><span class="pre">Context</span></code> class begin at 0xa0. When encountering an object tagged by 0xa0, we&#8217;ll need to know the context to be able to decode it. For example, in SNMP context, 0xa0 is a PDU_GET object, while in X509 context, it is a container for the certificate version.</p>
<p>Other objects are created by assembling all those basic brick objects. The composition is done using sequences and arrays (sets) of previously defined or existing objects. The final object (an X509 certificate, a SNMP packet) is a tree whose non-leaf nodes are sequences and sets objects (or derived context objects), and whose leaf nodes are integers, strings, OID, etc.</p>
</div>
<div class="section" id="scapy-and-asn-1">
<h3>Scapy and ASN.1<a class="headerlink" href="#scapy-and-asn-1" title="Permalink to this headline">¶</a></h3>
<p>Scapy provides a way to easily encode or decode ASN.1 and also program those encoders/decoders. It is quite more lax than what an ASN.1 parser should be, and it kind of ignores constraints. It won&#8217;t replace neither an ASN.1 parser nor an ASN.1 compiler. Actually, it has been written to be able to encode and decode broken ASN.1. It can handle corrupted encoded strings and can also create those.</p>
<div class="section" id="asn-1-engine">
<h4>ASN.1 engine<a class="headerlink" href="#asn-1-engine" title="Permalink to this headline">¶</a></h4>
<p>Note: many of the classes definitions presented here use metaclasses. If you don&#8217;t look precisely at the source code and you only rely on my captures, you may think they sometimes exhibit a kind of magic behaviour.
``
Scapy ASN.1 engine provides classes to link objects and their tags. They inherit from the <code class="docutils literal"><span class="pre">ASN1_Class</span></code>. The first one is <code class="docutils literal"><span class="pre">ASN1_Class_UNIVERSAL</span></code>, which provide tags for most Universal objects. Each new context (<code class="docutils literal"><span class="pre">SNMP</span></code>, <code class="docutils literal"><span class="pre">X509</span></code>) will inherit from it and add its own objects.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ASN1_Class_UNIVERSAL</span><span class="p">(</span><span class="n">ASN1_Class</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;UNIVERSAL&quot;</span>
<span class="c1"># [...]</span>
    <span class="n">BOOLEAN</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">INTEGER</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">BIT_STRING</span> <span class="o">=</span> <span class="mi">3</span>
<span class="c1"># [...]</span>

<span class="k">class</span> <span class="nc">ASN1_Class_SNMP</span><span class="p">(</span><span class="n">ASN1_Class_UNIVERSAL</span><span class="p">):</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;SNMP&quot;</span>
    <span class="n">PDU_GET</span> <span class="o">=</span> <span class="mh">0xa0</span>
    <span class="n">PDU_NEXT</span> <span class="o">=</span> <span class="mh">0xa1</span>
    <span class="n">PDU_RESPONSE</span> <span class="o">=</span> <span class="mh">0xa2</span>

<span class="k">class</span> <span class="nc">ASN1_Class_X509</span><span class="p">(</span><span class="n">ASN1_Class_UNIVERSAL</span><span class="p">):</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;X509&quot;</span>
    <span class="n">CONT0</span> <span class="o">=</span> <span class="mh">0xa0</span>
    <span class="n">CONT1</span> <span class="o">=</span> <span class="mh">0xa1</span>
<span class="c1"># [...]</span>
</pre></div>
</div>
<p>All ASN.1 objects are represented by simple Python instances that act as nutshells for the raw values. The simple logic is handled by <code class="docutils literal"><span class="pre">ASN1_Object</span></code> whose they inherit from. Hence they are quite simple:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ASN1_INTEGER</span><span class="p">(</span><span class="n">ASN1_Object</span><span class="p">):</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">ASN1_Class_UNIVERSAL</span><span class="o">.</span><span class="n">INTEGER</span>

<span class="k">class</span> <span class="nc">ASN1_STRING</span><span class="p">(</span><span class="n">ASN1_Object</span><span class="p">):</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">ASN1_Class_UNIVERSAL</span><span class="o">.</span><span class="n">STRING</span>

<span class="k">class</span> <span class="nc">ASN1_BIT_STRING</span><span class="p">(</span><span class="n">ASN1_STRING</span><span class="p">):</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">ASN1_Class_UNIVERSAL</span><span class="o">.</span><span class="n">BIT_STRING</span>
</pre></div>
</div>
<p>These instances can be assembled to create an ASN.1 tree:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">=</span><span class="n">ASN1_SEQUENCE</span><span class="p">([</span><span class="n">ASN1_INTEGER</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span><span class="n">ASN1_STRING</span><span class="p">(</span><span class="s2">&quot;egg&quot;</span><span class="p">),</span><span class="n">ASN1_SEQUENCE</span><span class="p">([</span><span class="n">ASN1_BOOLEAN</span><span class="p">(</span><span class="bp">False</span><span class="p">)])])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span>
<span class="go">&lt;ASN1_SEQUENCE[[&lt;ASN1_INTEGER[7]&gt;, &lt;ASN1_STRING[&#39;egg&#39;]&gt;, &lt;ASN1_SEQUENCE[[&lt;ASN1_BOOLEAN[False]&gt;]]&gt;]]&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="go"># ASN1_SEQUENCE:</span>
<span class="go">  &lt;ASN1_INTEGER[7]&gt;</span>
<span class="go">  &lt;ASN1_STRING[&#39;egg&#39;]&gt;</span>
<span class="go">  # ASN1_SEQUENCE:</span>
<span class="go">    &lt;ASN1_BOOLEAN[False]&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="encoding-engines">
<h4>Encoding engines<a class="headerlink" href="#encoding-engines" title="Permalink to this headline">¶</a></h4>
<p>As with the standard, ASN.1 and encoding are independent. We have just seen how to create a compounded ASN.1 object. To encode or decode it, we need to choose an encoding rule. Scapy provides only BER for the moment (actually, it may be DER. DER looks like BER except only minimal encoding is authorised which may well be what I did). I call this an ASN.1 codec.</p>
<p>Encoding and decoding are done using class methods provided by the codec. For example the <code class="docutils literal"><span class="pre">BERcodec_INTEGER</span></code> class provides a <code class="docutils literal"><span class="pre">.enc()</span></code> and a <code class="docutils literal"><span class="pre">.dec()</span></code> class methods that can convert between an encoded string and a value of their type. They all inherit from BERcodec_Object which is able to decode objects from any type:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">BERcodec_INTEGER</span><span class="o">.</span><span class="n">enc</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="go">&#39;\x02\x01\x07&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">BERcodec_BIT_STRING</span><span class="o">.</span><span class="n">enc</span><span class="p">(</span><span class="s2">&quot;egg&quot;</span><span class="p">)</span>
<span class="go">&#39;\x03\x03egg&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">BERcodec_STRING</span><span class="o">.</span><span class="n">enc</span><span class="p">(</span><span class="s2">&quot;egg&quot;</span><span class="p">)</span>
<span class="go">&#39;\x04\x03egg&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">BERcodec_STRING</span><span class="o">.</span><span class="n">dec</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x04\x03</span><span class="s1">egg&#39;</span><span class="p">)</span>
<span class="go">(&lt;ASN1_STRING[&#39;egg&#39;]&gt;, &#39;&#39;)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">BERcodec_STRING</span><span class="o">.</span><span class="n">dec</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x03\x03</span><span class="s1">egg&#39;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;console&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">?</span>
  File <span class="nb">&quot;/usr/bin/scapy&quot;</span>, line <span class="m">2099</span>, in <span class="n">dec</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">do_dec</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">safe</span><span class="p">)</span>
  File <span class="nb">&quot;/usr/bin/scapy&quot;</span>, line <span class="m">2178</span>, in <span class="n">do_dec</span>
    <span class="n">l</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">t</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">check_type_check_len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  File <span class="nb">&quot;/usr/bin/scapy&quot;</span>, line <span class="m">2076</span>, in <span class="n">check_type_check_len</span>
    <span class="n">l</span><span class="p">,</span><span class="n">s3</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">check_type_get_len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  File <span class="nb">&quot;/usr/bin/scapy&quot;</span>, line <span class="m">2069</span>, in <span class="n">check_type_get_len</span>
    <span class="n">s2</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">check_type</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
  File <span class="nb">&quot;/usr/bin/scapy&quot;</span>, line <span class="m">2065</span>, in <span class="n">check_type</span>
    <span class="p">(</span><span class="n">cls</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">ord</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">cls</span><span class="o">.</span><span class="n">tag</span><span class="p">),</span> <span class="n">remaining</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
<span class="gr">BER_BadTag_Decoding_Error</span>: <span class="n">BERcodec_STRING: Got tag [3/0x3] while expecting &lt;ASN1Tag STRING[4]&gt;</span>
<span class="go">### Already decoded ###</span>
<span class="go">None</span>
<span class="go">### Remaining ###</span>
<span class="go">&#39;\x03\x03egg&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">BERcodec_Object</span><span class="o">.</span><span class="n">dec</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\x03\x03</span><span class="s1">egg&#39;</span><span class="p">)</span>
<span class="go">(&lt;ASN1_BIT_STRING[&#39;egg&#39;]&gt;, &#39;&#39;)</span>
</pre></div>
</div>
<p>ASN.1 objects are encoded using their <code class="docutils literal"><span class="pre">.enc()</span></code> method. This method must be called with the codec we want to use. All codecs are referenced in the ASN1_Codecs object. <code class="docutils literal"><span class="pre">str()</span></code> can also be used. In this case, the default codec (<code class="docutils literal"><span class="pre">conf.ASN1_default_codec</span></code>) will be used.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">x</span><span class="o">.</span><span class="n">enc</span><span class="p">(</span><span class="n">ASN1_Codecs</span><span class="o">.</span><span class="n">BER</span><span class="p">)</span>
<span class="go">&#39;0\r\x02\x01\x07\x04\x03egg0\x03\x01\x01\x00&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">&#39;0\r\x02\x01\x07\x04\x03egg0\x03\x01\x01\x00&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">xx</span><span class="p">,</span><span class="n">remain</span> <span class="o">=</span> <span class="n">BERcodec_Object</span><span class="o">.</span><span class="n">dec</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">xx</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="go"># ASN1_SEQUENCE:</span>
<span class="go">  &lt;ASN1_INTEGER[7L]&gt;</span>
<span class="go">  &lt;ASN1_STRING[&#39;egg&#39;]&gt;</span>
<span class="go">  # ASN1_SEQUENCE:</span>
<span class="go">    &lt;ASN1_BOOLEAN[0L]&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">remain</span>
<span class="go">&#39;&#39;</span>
</pre></div>
</div>
<p>By default, decoding is done using the <code class="docutils literal"><span class="pre">Universal</span></code> class, which means objects defined in the <code class="docutils literal"><span class="pre">Context</span></code> class will not be decoded. There is a good reason for that: the decoding depends on the context!</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cert</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="gp">... </span><span class="s2">MIIF5jCCA86gAwIBAgIBATANBgkqhkiG9w0BAQUFADCBgzELMAkGA1UEBhMC</span>
<span class="gp">... </span><span class="s2">VVMxHTAbBgNVBAoTFEFPTCBUaW1lIFdhcm5lciBJbmMuMRwwGgYDVQQLExNB</span>
<span class="gp">... </span><span class="s2">bWVyaWNhIE9ubGluZSBJbmMuMTcwNQYDVQQDEy5BT0wgVGltZSBXYXJuZXIg</span>
<span class="gp">... </span><span class="s2">Um9vdCBDZXJ0aWZpY2F0aW9uIEF1dGhvcml0eSAyMB4XDTAyMDUyOTA2MDAw</span>
<span class="gp">... </span><span class="s2">MFoXDTM3MDkyODIzNDMwMFowgYMxCzAJBgNVBAYTAlVTMR0wGwYDVQQKExRB</span>
<span class="gp">... </span><span class="s2">T0wgVGltZSBXYXJuZXIgSW5jLjEcMBoGA1UECxMTQW1lcmljYSBPbmxpbmUg</span>
<span class="gp">... </span><span class="s2">SW5jLjE3MDUGA1UEAxMuQU9MIFRpbWUgV2FybmVyIFJvb3QgQ2VydGlmaWNh</span>
<span class="gp">... </span><span class="s2">dGlvbiBBdXRob3JpdHkgMjCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoC</span>
<span class="gp">... </span><span class="s2">ggIBALQ3WggWmRToVbEbJGv8x4vmh6mJ7ouZzU9AhqS2TcnZsdw8TQ2FTBVs</span>
<span class="gp">... </span><span class="s2">RotSeJ/4I/1n9SQ6aF3Q92RhQVSji6UI0ilbm2BPJoPRYxJWSXakFsKlnUWs</span>
<span class="gp">... </span><span class="s2">i4SVqBax7J/qJBrvuVdcmiQhLE0OcR+mrF1FdAOYxFSMFkpBd4aVdQxHAWZg</span>
<span class="gp">... </span><span class="s2">/BXxD+r1FHjHDtdugRxev17nOirYlxcwfACtCJ0zr7iZYYCLqJV+FNwSbKTQ</span>
<span class="gp">... </span><span class="s2">2O9ASQI2+W6p1h2WVgSysy0WVoaP2SBXgM1nEG2wTPDaRrbqJS5Gr42whTg0</span>
<span class="gp">... </span><span class="s2">ixQmgiusrpkLjhTXUr2eacOGAgvqdnUxCc4zGSGFQ+aJLZ8lN2fxI2rSAG2X</span>
<span class="gp">... </span><span class="s2">+Z/nKcrdH9cG6rjJuQkhn8g/BsXS6RJGAE57COtCPStIbp1n3UsC5ETzkxml</span>
<span class="gp">... </span><span class="s2">J85per5n0/xQpCyrw2u544BMzwVhSyvcG7mm0tCq9Stz+86QNZ8MUhy/XCFh</span>
<span class="gp">... </span><span class="s2">EVsVS6kkUfykXPcXnbDS+gfpj1bkGoxoigTTfFrjnqKhynFbotSg5ymFXQNo</span>
<span class="gp">... </span><span class="s2">Kk/SBtc9+cMDLz9l+WceR0DTYw/j1Y75hauXTLPXJuuWCpTehTacyH+BCQJJ</span>
<span class="gp">... </span><span class="s2">Kg71ZDIMgtG6aoIbs0t0EfOMd9afv9w3pKdVBC/UMejTRrkDfNoSTllkt1Ex</span>
<span class="gp">... </span><span class="s2">MVCgyhwn2RAurda9EGYrw7AiShJbAgMBAAGjYzBhMA8GA1UdEwEB/wQFMAMB</span>
<span class="gp">... </span><span class="s2">Af8wHQYDVR0OBBYEFE9pbQN+nZ8HGEO8txBO1b+pxCAoMB8GA1UdIwQYMBaA</span>
<span class="gp">... </span><span class="s2">FE9pbQN+nZ8HGEO8txBO1b+pxCAoMA4GA1UdDwEB/wQEAwIBhjANBgkqhkiG</span>
<span class="gp">... </span><span class="s2">9w0BAQUFAAOCAgEAO/Ouyuguh4X7ZVnnrREUpVe8WJ8kEle7+z802u6teio0</span>
<span class="gp">... </span><span class="s2">cnAxa8cZmIDJgt43d15Ui47y6mdPyXSEkVYJ1eV6moG2gcKtNuTxVBFT8zRF</span>
<span class="gp">... </span><span class="s2">ASbI5Rq8NEQh3q0l/HYWdyGQgJhXnU7q7C+qPBR7V8F+GBRn7iTGvboVsNIY</span>
<span class="gp">... </span><span class="s2">vbdVgaxTwOjdaRITQrcCtQVBynlQboIOcXKTRuidDV29rs4prWPVVRaAMCf/</span>
<span class="gp">... </span><span class="s2">drr3uNZK49m1+VLQTkCpx+XCMseqdiThawVQ68W/ClTluUI8JPu3B5wwn3la</span>
<span class="gp">... </span><span class="s2">5uBAUhX0/Kr0VvlEl4ftDmVyXr4m+02kLQgH3thcoNyBM5kYJRF3p+v9WAks</span>
<span class="gp">... </span><span class="s2">mWsbivNSPxpNSGDxoPYzAlOL7SUJuA0t7Zdz7NeWH45gDtoQmy8YJPamTQr5</span>
<span class="gp">... </span><span class="s2">O8t1wswvziRpyQoijlmn94IM19drNZxDAGrElWe6nEXLuA4399xOAU++CrYD</span>
<span class="gp">... </span><span class="s2">062KRffaJ00psUjf5BHklka9bAI+1lHIlRcBFanyqqryvy9lG2/QuRqT9Y41</span>
<span class="gp">... </span><span class="s2">xICHPpQvZuTpqP9BnHAqTyo5GJUefvthATxRCC4oGKQWDzH9OmwjkyB24f0H</span>
<span class="gp">... </span><span class="s2">hdFbP9IcczLd+rn4jM8Ch3qaluTtT4mNU0OrDhPAARW0eTjb/G49nlG2uBOL</span>
<span class="gp">... </span><span class="s2">Z8/5fNkiHfZdxRwBL5joeiQYvITX+txyW/fBOmg=</span>
<span class="gp">... </span><span class="s2">&quot;&quot;&quot;</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;base64&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">dcert</span><span class="p">,</span><span class="n">remain</span><span class="p">)</span> <span class="o">=</span> <span class="n">BERcodec_Object</span><span class="o">.</span><span class="n">dec</span><span class="p">(</span><span class="n">cert</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;console&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">?</span>
  File <span class="nb">&quot;/usr/bin/scapy&quot;</span>, line <span class="m">2099</span>, in <span class="n">dec</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">do_dec</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">safe</span><span class="p">)</span>
  File <span class="nb">&quot;/usr/bin/scapy&quot;</span>, line <span class="m">2094</span>, in <span class="n">do_dec</span>
    <span class="k">return</span> <span class="n">codec</span><span class="o">.</span><span class="n">dec</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">context</span><span class="p">,</span><span class="n">safe</span><span class="p">)</span>
  File <span class="nb">&quot;/usr/bin/scapy&quot;</span>, line <span class="m">2099</span>, in <span class="n">dec</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">do_dec</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">safe</span><span class="p">)</span>
  File <span class="nb">&quot;/usr/bin/scapy&quot;</span>, line <span class="m">2218</span>, in <span class="n">do_dec</span>
    <span class="n">o</span><span class="p">,</span><span class="n">s</span> <span class="o">=</span> <span class="n">BERcodec_Object</span><span class="o">.</span><span class="n">dec</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">safe</span><span class="p">)</span>
  File <span class="nb">&quot;/usr/bin/scapy&quot;</span>, line <span class="m">2099</span>, in <span class="n">dec</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">do_dec</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">safe</span><span class="p">)</span>
  File <span class="nb">&quot;/usr/bin/scapy&quot;</span>, line <span class="m">2094</span>, in <span class="n">do_dec</span>
    <span class="k">return</span> <span class="n">codec</span><span class="o">.</span><span class="n">dec</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">context</span><span class="p">,</span><span class="n">safe</span><span class="p">)</span>
  File <span class="nb">&quot;/usr/bin/scapy&quot;</span>, line <span class="m">2099</span>, in <span class="n">dec</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">do_dec</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">safe</span><span class="p">)</span>
  File <span class="nb">&quot;/usr/bin/scapy&quot;</span>, line <span class="m">2218</span>, in <span class="n">do_dec</span>
    <span class="n">o</span><span class="p">,</span><span class="n">s</span> <span class="o">=</span> <span class="n">BERcodec_Object</span><span class="o">.</span><span class="n">dec</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">safe</span><span class="p">)</span>
  File <span class="nb">&quot;/usr/bin/scapy&quot;</span>, line <span class="m">2099</span>, in <span class="n">dec</span>
    <span class="k">return</span> <span class="n">cls</span><span class="o">.</span><span class="n">do_dec</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">safe</span><span class="p">)</span>
  File <span class="nb">&quot;/usr/bin/scapy&quot;</span>, line <span class="m">2092</span>, in <span class="n">do_dec</span>
    <span class="k">raise</span> <span class="n">BER_Decoding_Error</span><span class="p">(</span><span class="s2">&quot;Unknown prefix [</span><span class="si">%02x</span><span class="s2">] for [</span><span class="si">%r</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">t</span><span class="p">),</span> <span class="n">remaining</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
<span class="gr">BER_Decoding_Error</span>: <span class="n">Unknown prefix [a0] for [&#39;\xa0\x03\x02\x01\x02\x02\x01\x010\r\x06\t*\x86H...&#39;]</span>
<span class="go">### Already decoded ###</span>
<span class="go">[[]]</span>
<span class="go">### Remaining ###</span>
<span class="go">&#39;\xa0\x03\x02\x01\x02\x02\x01\x010\r\x06\t*\x86H\x86\xf7\r\x01\x01\x05\x05\x000\x81\x831\x0b0\t\x06\x03U\x04\x06\x13\x02US1\x1d0\x1b\x06\x03U\x04\n\x13\x14AOL Time Warner Inc.1\x1c0\x1a\x06\x03U\x04\x0b\x13\x13America Online Inc.1705\x06\x03U\x04\x03\x13.AOL Time Warner Root Certification Authority 20\x1e\x17\r020529060000Z\x17\r370928234300Z0\x81\x831\x0b0\t\x06\x03U\x04\x06\x13\x02US1\x1d0\x1b\x06\x03U\x04\n\x13\x14AOL Time Warner Inc.1\x1c0\x1a\x06\x03U\x04\x0b\x13\x13America Online Inc.1705\x06\x03U\x04\x03\x13.AOL Time Warner Root Certification Authority 20\x82\x02&quot;0\r\x06\t*\x86H\x86\xf7\r\x01\x01\x01\x05\x00\x03\x82\x02\x0f\x000\x82\x02\n\x02\x82\x02\x01\x00\xb47Z\x08\x16\x99\x14\xe8U\xb1\x1b$k\xfc\xc7\x8b\xe6\x87\xa9\x89\xee\x8b\x99\xcdO@\x86\xa4\xb6M\xc9\xd9\xb1\xdc&lt;M\r\x85L\x15lF\x8bRx\x9f\xf8#\xfdg\xf5$:h]\xd0\xf7daAT\xa3\x8b\xa5\x08\xd2)[\x9b`O&amp;\x83\xd1c\x12VIv\xa4\x16\xc2\xa5\x9dE\xac\x8b\x84\x95\xa8\x16\xb1\xec\x9f\xea$\x1a\xef\xb9W\\\x9a$!,M\x0eq\x1f\xa6\xac]Et\x03\x98\xc4T\x8c\x16JAw\x86\x95u\x0cG\x01f`\xfc\x15\xf1\x0f\xea\xf5\x14x\xc7\x0e\xd7n\x81\x1c^\xbf^\xe7:*\xd8\x97\x170|\x00\xad\x08\x9d3\xaf\xb8\x99a\x80\x8b\xa8\x95~\x14\xdc\x12l\xa4\xd0\xd8\xef@I\x026\xf9n\xa9\xd6\x1d\x96V\x04\xb2\xb3-\x16V\x86\x8f\xd9 W\x80\xcdg\x10m\xb0L\xf0\xdaF\xb6\xea%.F\xaf\x8d\xb0\x8584\x8b\x14&amp;\x82+\xac\xae\x99\x0b\x8e\x14\xd7R\xbd\x9ei\xc3\x86\x02\x0b\xeavu1\t\xce3\x19!\x85C\xe6\x89-\x9f%7g\xf1#j\xd2\x00m\x97\xf9\x9f\xe7)\xca\xdd\x1f\xd7\x06\xea\xb8\xc9\xb9\t!\x9f\xc8?\x06\xc5\xd2\xe9\x12F\x00N{\x08\xebB=+Hn\x9dg\xddK\x02\xe4D\xf3\x93\x19\xa5\&#39;\xceiz\xbeg\xd3\xfcP\xa4,\xab\xc3k\xb9\xe3\x80L\xcf\x05aK+\xdc\x1b\xb9\xa6\xd2\xd0\xaa\xf5+s\xfb\xce\x905\x9f\x0cR\x1c\xbf\\!a\x11[\x15K\xa9$Q\xfc\xa4\\\xf7\x17\x9d\xb0\xd2\xfa\x07\xe9\x8fV\xe4\x1a\x8ch\x8a\x04\xd3|Z\xe3\x9e\xa2\xa1\xcaq[\xa2\xd4\xa0\xe7)\x85]\x03h*O\xd2\x06\xd7=\xf9\xc3\x03/?e\xf9g\x1eG@\xd3c\x0f\xe3\xd5\x8e\xf9\x85\xab\x97L\xb3\xd7&amp;\xeb\x96\n\x94\xde\x856\x9c\xc8\x7f\x81\t\x02I*\x0e\xf5d2\x0c\x82\xd1\xbaj\x82\x1b\xb3Kt\x11\xf3\x8cw\xd6\x9f\xbf\xdc7\xa4\xa7U\x04/\xd41\xe8\xd3F\xb9\x03|\xda\x12NYd\xb7Q11P\xa0\xca\x1c\&#39;\xd9\x10.\xad\xd6\xbd\x10f+\xc3\xb0&quot;J\x12[\x02\x03\x01\x00\x01\xa3c0a0\x0f\x06\x03U\x1d\x13\x01\x01\xff\x04\x050\x03\x01\x01\xff0\x1d\x06\x03U\x1d\x0e\x04\x16\x04\x14Oim\x03~\x9d\x9f\x07\x18C\xbc\xb7\x10N\xd5\xbf\xa9\xc4 (0\x1f\x06\x03U\x1d#\x04\x180\x16\x80\x14Oim\x03~\x9d\x9f\x07\x18C\xbc\xb7\x10N\xd5\xbf\xa9\xc4 (0\x0e\x06\x03U\x1d\x0f\x01\x01\xff\x04\x04\x03\x02\x01\x860\r\x06\t*\x86H\x86\xf7\r\x01\x01\x05\x05\x00\x03\x82\x02\x01\x00;\xf3\xae\xca\xe8.\x87\x85\xfbeY\xe7\xad\x11\x14\xa5W\xbcX\x9f$\x12W\xbb\xfb?4\xda\xee\xadz*4rp1k\xc7\x19\x98\x80\xc9\x82\xde7w^T\x8b\x8e\xf2\xeagO\xc9t\x84\x91V\t\xd5\xe5z\x9a\x81\xb6\x81\xc2\xad6\xe4\xf1T\x11S\xf34E\x01&amp;\xc8\xe5\x1a\xbc4D!\xde\xad%\xfcv\x16w!\x90\x80\x98W\x9dN\xea\xec/\xaa&lt;\x14{W\xc1~\x18\x14g\xee$\xc6\xbd\xba\x15\xb0\xd2\x18\xbd\xb7U\x81\xacS\xc0\xe8\xddi\x12\x13B\xb7\x02\xb5\x05A\xcayPn\x82\x0eqr\x93F\xe8\x9d\r]\xbd\xae\xce)\xadc\xd5U\x16\x800\&#39;\xffv\xba\xf7\xb8\xd6J\xe3\xd9\xb5\xf9R\xd0N@\xa9\xc7\xe5\xc22\xc7\xaav$\xe1k\x05P\xeb\xc5\xbf\nT\xe5\xb9B&lt;$\xfb\xb7\x07\x9c0\x9fyZ\xe6\xe0@R\x15\xf4\xfc\xaa\xf4V\xf9D\x97\x87\xed\x0eer^\xbe&amp;\xfbM\xa4-\x08\x07\xde\xd8\\\xa0\xdc\x813\x99\x18%\x11w\xa7\xeb\xfdX\t,\x99k\x1b\x8a\xf3R?\x1aMH`\xf1\xa0\xf63\x02S\x8b\xed%\t\xb8\r-\xed\x97s\xec\xd7\x96\x1f\x8e`\x0e\xda\x10\x9b/\x18$\xf6\xa6M\n\xf9;\xcbu\xc2\xcc/\xce$i\xc9\n&quot;\x8eY\xa7\xf7\x82\x0c\xd7\xd7k5\x9cC\x00j\xc4\x95g\xba\x9cE\xcb\xb8\x0e7\xf7\xdcN\x01O\xbe\n\xb6\x03\xd3\xad\x8aE\xf7\xda\&#39;M)\xb1H\xdf\xe4\x11\xe4\x96F\xbdl\x02&gt;\xd6Q\xc8\x95\x17\x01\x15\xa9\xf2\xaa\xaa\xf2\xbf/e\x1bo\xd0\xb9\x1a\x93\xf5\x8e5\xc4\x80\x87&gt;\x94/f\xe4\xe9\xa8\xffA\x9cp*O*9\x18\x95\x1e~\xfba\x01&lt;Q\x08.(\x18\xa4\x16\x0f1\xfd:l#\x93 v\xe1\xfd\x07\x85\xd1[?\xd2\x1cs2\xdd\xfa\xb9\xf8\x8c\xcf\x02\x87z\x9a\x96\xe4\xedO\x89\x8dSC\xab\x0e\x13\xc0\x01\x15\xb4y8\xdb\xfcn=\x9eQ\xb6\xb8\x13\x8bg\xcf\xf9|\xd9&quot;\x1d\xf6]\xc5\x1c\x01/\x98\xe8z$\x18\xbc\x84\xd7\xfa\xdcr[\xf7\xc1:h&#39;</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">Context</span></code> class must be specified:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">dcert</span><span class="p">,</span><span class="n">remain</span><span class="p">)</span> <span class="o">=</span> <span class="n">BERcodec_Object</span><span class="o">.</span><span class="n">dec</span><span class="p">(</span><span class="n">cert</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">ASN1_Class_X509</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dcert</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="go"># ASN1_SEQUENCE:</span>
<span class="go">  # ASN1_SEQUENCE:</span>
<span class="go">    # ASN1_X509_CONT0:</span>
<span class="go">      &lt;ASN1_INTEGER[2L]&gt;</span>
<span class="go">    &lt;ASN1_INTEGER[1L]&gt;</span>
<span class="go">    # ASN1_SEQUENCE:</span>
<span class="go">      &lt;ASN1_OID[&#39;.1.2.840.113549.1.1.5&#39;]&gt;</span>
<span class="go">      &lt;ASN1_NULL[0L]&gt;</span>
<span class="go">    # ASN1_SEQUENCE:</span>
<span class="go">      # ASN1_SET:</span>
<span class="go">        # ASN1_SEQUENCE:</span>
<span class="go">          &lt;ASN1_OID[&#39;.2.5.4.6&#39;]&gt;</span>
<span class="go">          &lt;ASN1_PRINTABLE_STRING[&#39;US&#39;]&gt;</span>
<span class="go">      # ASN1_SET:</span>
<span class="go">        # ASN1_SEQUENCE:</span>
<span class="go">          &lt;ASN1_OID[&#39;.2.5.4.10&#39;]&gt;</span>
<span class="go">          &lt;ASN1_PRINTABLE_STRING[&#39;AOL Time Warner Inc.&#39;]&gt;</span>
<span class="go">      # ASN1_SET:</span>
<span class="go">        # ASN1_SEQUENCE:</span>
<span class="go">          &lt;ASN1_OID[&#39;.2.5.4.11&#39;]&gt;</span>
<span class="go">          &lt;ASN1_PRINTABLE_STRING[&#39;America Online Inc.&#39;]&gt;</span>
<span class="go">      # ASN1_SET:</span>
<span class="go">        # ASN1_SEQUENCE:</span>
<span class="go">          &lt;ASN1_OID[&#39;.2.5.4.3&#39;]&gt;</span>
<span class="go">          &lt;ASN1_PRINTABLE_STRING[&#39;AOL Time Warner Root Certification Authority 2&#39;]&gt;</span>
<span class="go">    # ASN1_SEQUENCE:</span>
<span class="go">      &lt;ASN1_UTC_TIME[&#39;020529060000Z&#39;]&gt;</span>
<span class="go">      &lt;ASN1_UTC_TIME[&#39;370928234300Z&#39;]&gt;</span>
<span class="go">    # ASN1_SEQUENCE:</span>
<span class="go">      # ASN1_SET:</span>
<span class="go">        # ASN1_SEQUENCE:</span>
<span class="go">          &lt;ASN1_OID[&#39;.2.5.4.6&#39;]&gt;</span>
<span class="go">          &lt;ASN1_PRINTABLE_STRING[&#39;US&#39;]&gt;</span>
<span class="go">      # ASN1_SET:</span>
<span class="go">        # ASN1_SEQUENCE:</span>
<span class="go">          &lt;ASN1_OID[&#39;.2.5.4.10&#39;]&gt;</span>
<span class="go">          &lt;ASN1_PRINTABLE_STRING[&#39;AOL Time Warner Inc.&#39;]&gt;</span>
<span class="go">      # ASN1_SET:</span>
<span class="go">        # ASN1_SEQUENCE:</span>
<span class="go">          &lt;ASN1_OID[&#39;.2.5.4.11&#39;]&gt;</span>
<span class="go">          &lt;ASN1_PRINTABLE_STRING[&#39;America Online Inc.&#39;]&gt;</span>
<span class="go">      # ASN1_SET:</span>
<span class="go">        # ASN1_SEQUENCE:</span>
<span class="go">          &lt;ASN1_OID[&#39;.2.5.4.3&#39;]&gt;</span>
<span class="go">          &lt;ASN1_PRINTABLE_STRING[&#39;AOL Time Warner Root Certification Authority 2&#39;]&gt;</span>
<span class="go">    # ASN1_SEQUENCE:</span>
<span class="go">      # ASN1_SEQUENCE:</span>
<span class="go">        &lt;ASN1_OID[&#39;.1.2.840.113549.1.1.1&#39;]&gt;</span>
<span class="go">        &lt;ASN1_NULL[0L]&gt;</span>
<span class="go">      &lt;ASN1_BIT_STRING[&#39;\x000\x82\x02\n\x02\x82\x02\x01\x00\xb47Z\x08\x16\x99\x14\xe8U\xb1\x1b$k\xfc\xc7\x8b\xe6\x87\xa9\x89\xee\x8b\x99\xcdO@\x86\xa4\xb6M\xc9\xd9\xb1\xdc&lt;M\r\x85L\x15lF\x8bRx\x9f\xf8#\xfdg\xf5$:h]\xd0\xf7daAT\xa3\x8b\xa5\x08\xd2)[\x9b`O&amp;\x83\xd1c\x12VIv\xa4\x16\xc2\xa5\x9dE\xac\x8b\x84\x95\xa8\x16\xb1\xec\x9f\xea$\x1a\xef\xb9W\\\x9a$!,M\x0eq\x1f\xa6\xac]Et\x03\x98\xc4T\x8c\x16JAw\x86\x95u\x0cG\x01f`\xfc\x15\xf1\x0f\xea\xf5\x14x\xc7\x0e\xd7n\x81\x1c^\xbf^\xe7:*\xd8\x97\x170|\x00\xad\x08\x9d3\xaf\xb8\x99a\x80\x8b\xa8\x95~\x14\xdc\x12l\xa4\xd0\xd8\xef@I\x026\xf9n\xa9\xd6\x1d\x96V\x04\xb2\xb3-\x16V\x86\x8f\xd9 W\x80\xcdg\x10m\xb0L\xf0\xdaF\xb6\xea%.F\xaf\x8d\xb0\x8584\x8b\x14&amp;\x82+\xac\xae\x99\x0b\x8e\x14\xd7R\xbd\x9ei\xc3\x86\x02\x0b\xeavu1\t\xce3\x19!\x85C\xe6\x89-\x9f%7g\xf1#j\xd2\x00m\x97\xf9\x9f\xe7)\xca\xdd\x1f\xd7\x06\xea\xb8\xc9\xb9\t!\x9f\xc8?\x06\xc5\xd2\xe9\x12F\x00N{\x08\xebB=+Hn\x9dg\xddK\x02\xe4D\xf3\x93\x19\xa5\&#39;\xceiz\xbeg\xd3\xfcP\xa4,\xab\xc3k\xb9\xe3\x80L\xcf\x05aK+\xdc\x1b\xb9\xa6\xd2\xd0\xaa\xf5+s\xfb\xce\x905\x9f\x0cR\x1c\xbf\\!a\x11[\x15K\xa9$Q\xfc\xa4\\\xf7\x17\x9d\xb0\xd2\xfa\x07\xe9\x8fV\xe4\x1a\x8ch\x8a\x04\xd3|Z\xe3\x9e\xa2\xa1\xcaq[\xa2\xd4\xa0\xe7)\x85]\x03h*O\xd2\x06\xd7=\xf9\xc3\x03/?e\xf9g\x1eG@\xd3c\x0f\xe3\xd5\x8e\xf9\x85\xab\x97L\xb3\xd7&amp;\xeb\x96\n\x94\xde\x856\x9c\xc8\x7f\x81\t\x02I*\x0e\xf5d2\x0c\x82\xd1\xbaj\x82\x1b\xb3Kt\x11\xf3\x8cw\xd6\x9f\xbf\xdc7\xa4\xa7U\x04/\xd41\xe8\xd3F\xb9\x03|\xda\x12NYd\xb7Q11P\xa0\xca\x1c\&#39;\xd9\x10.\xad\xd6\xbd\x10f+\xc3\xb0&quot;J\x12[\x02\x03\x01\x00\x01&#39;]&gt;</span>
<span class="go">    # ASN1_X509_CONT3:</span>
<span class="go">      # ASN1_SEQUENCE:</span>
<span class="go">        # ASN1_SEQUENCE:</span>
<span class="go">          &lt;ASN1_OID[&#39;.2.5.29.19&#39;]&gt;</span>
<span class="go">          &lt;ASN1_BOOLEAN[-1L]&gt;</span>
<span class="go">          &lt;ASN1_STRING[&#39;0\x03\x01\x01\xff&#39;]&gt;</span>
<span class="go">        # ASN1_SEQUENCE:</span>
<span class="go">          &lt;ASN1_OID[&#39;.2.5.29.14&#39;]&gt;</span>
<span class="go">          &lt;ASN1_STRING[&#39;\x04\x14Oim\x03~\x9d\x9f\x07\x18C\xbc\xb7\x10N\xd5\xbf\xa9\xc4 (&#39;]&gt;</span>
<span class="go">        # ASN1_SEQUENCE:</span>
<span class="go">          &lt;ASN1_OID[&#39;.2.5.29.35&#39;]&gt;</span>
<span class="go">          &lt;ASN1_STRING[&#39;0\x16\x80\x14Oim\x03~\x9d\x9f\x07\x18C\xbc\xb7\x10N\xd5\xbf\xa9\xc4 (&#39;]&gt;</span>
<span class="go">        # ASN1_SEQUENCE:</span>
<span class="go">          &lt;ASN1_OID[&#39;.2.5.29.15&#39;]&gt;</span>
<span class="go">          &lt;ASN1_BOOLEAN[-1L]&gt;</span>
<span class="go">          &lt;ASN1_STRING[&#39;\x03\x02\x01\x86&#39;]&gt;</span>
<span class="go">  # ASN1_SEQUENCE:</span>
<span class="go">    &lt;ASN1_OID[&#39;.1.2.840.113549.1.1.5&#39;]&gt;</span>
<span class="go">    &lt;ASN1_NULL[0L]&gt;</span>
<span class="go">  &lt;ASN1_BIT_STRING[&#39;\x00;\xf3\xae\xca\xe8.\x87\x85\xfbeY\xe7\xad\x11\x14\xa5W\xbcX\x9f$\x12W\xbb\xfb?4\xda\xee\xadz*4rp1k\xc7\x19\x98\x80\xc9\x82\xde7w^T\x8b\x8e\xf2\xeagO\xc9t\x84\x91V\t\xd5\xe5z\x9a\x81\xb6\x81\xc2\xad6\xe4\xf1T\x11S\xf34E\x01&amp;\xc8\xe5\x1a\xbc4D!\xde\xad%\xfcv\x16w!\x90\x80\x98W\x9dN\xea\xec/\xaa&lt;\x14{W\xc1~\x18\x14g\xee$\xc6\xbd\xba\x15\xb0\xd2\x18\xbd\xb7U\x81\xacS\xc0\xe8\xddi\x12\x13B\xb7\x02\xb5\x05A\xcayPn\x82\x0eqr\x93F\xe8\x9d\r]\xbd\xae\xce)\xadc\xd5U\x16\x800\&#39;\xffv\xba\xf7\xb8\xd6J\xe3\xd9\xb5\xf9R\xd0N@\xa9\xc7\xe5\xc22\xc7\xaav$\xe1k\x05P\xeb\xc5\xbf\nT\xe5\xb9B&lt;$\xfb\xb7\x07\x9c0\x9fyZ\xe6\xe0@R\x15\xf4\xfc\xaa\xf4V\xf9D\x97\x87\xed\x0eer^\xbe&amp;\xfbM\xa4-\x08\x07\xde\xd8\\\xa0\xdc\x813\x99\x18%\x11w\xa7\xeb\xfdX\t,\x99k\x1b\x8a\xf3R?\x1aMH`\xf1\xa0\xf63\x02S\x8b\xed%\t\xb8\r-\xed\x97s\xec\xd7\x96\x1f\x8e`\x0e\xda\x10\x9b/\x18$\xf6\xa6M\n\xf9;\xcbu\xc2\xcc/\xce$i\xc9\n&quot;\x8eY\xa7\xf7\x82\x0c\xd7\xd7k5\x9cC\x00j\xc4\x95g\xba\x9cE\xcb\xb8\x0e7\xf7\xdcN\x01O\xbe\n\xb6\x03\xd3\xad\x8aE\xf7\xda\&#39;M)\xb1H\xdf\xe4\x11\xe4\x96F\xbdl\x02&gt;\xd6Q\xc8\x95\x17\x01\x15\xa9\xf2\xaa\xaa\xf2\xbf/e\x1bo\xd0\xb9\x1a\x93\xf5\x8e5\xc4\x80\x87&gt;\x94/f\xe4\xe9\xa8\xffA\x9cp*O*9\x18\x95\x1e~\xfba\x01&lt;Q\x08.(\x18\xa4\x16\x0f1\xfd:l#\x93 v\xe1\xfd\x07\x85\xd1[?\xd2\x1cs2\xdd\xfa\xb9\xf8\x8c\xcf\x02\x87z\x9a\x96\xe4\xedO\x89\x8dSC\xab\x0e\x13\xc0\x01\x15\xb4y8\xdb\xfcn=\x9eQ\xb6\xb8\x13\x8bg\xcf\xf9|\xd9&quot;\x1d\xf6]\xc5\x1c\x01/\x98\xe8z$\x18\xbc\x84\xd7\xfa\xdcr[\xf7\xc1:h&#39;]&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="asn-1-layers">
<h4>ASN.1 layers<a class="headerlink" href="#asn-1-layers" title="Permalink to this headline">¶</a></h4>
<p>While this may be nice, it&#8217;s only an ASN.1 encoder/decoder. Nothing related to Scapy yet.</p>
<div class="section" id="asn-1-fields">
<h5>ASN.1 fields<a class="headerlink" href="#asn-1-fields" title="Permalink to this headline">¶</a></h5>
<p>Scapy provides ASN.1 fields. They will wrap ASN.1 objects and provide the necessary logic to bind a field name to the value. ASN.1 packets will be described as a tree of ASN.1 fields. Then each field name will be made available as a normal <code class="docutils literal"><span class="pre">Packet</span></code> object, in a flat flavor (ex: to access the version field of a SNMP packet, you don&#8217;t need to know how many containers wrap it).</p>
<p>Each ASN.1 field is linked to an ASN.1 object through its tag.</p>
</div>
<div class="section" id="asn-1-packets">
<h5>ASN.1 packets<a class="headerlink" href="#asn-1-packets" title="Permalink to this headline">¶</a></h5>
<p>ASN.1 packets inherit from the Packet class. Instead of a <code class="docutils literal"><span class="pre">fields_desc</span></code> list of fields, they define <code class="docutils literal"><span class="pre">ASN1_codec</span></code> and <code class="docutils literal"><span class="pre">ASN1_root</span></code> attributes. The first one is a codec (for example: <code class="docutils literal"><span class="pre">ASN1_Codecs.BER</span></code>), the second one is a tree compounded with ASN.1 fields.</p>
</div>
</div>
</div>
<div class="section" id="a-complete-example-snmp">
<h3>A complete example: SNMP<a class="headerlink" href="#a-complete-example-snmp" title="Permalink to this headline">¶</a></h3>
<p>SNMP defines new ASN.1 objects. We need to define them:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ASN1_Class_SNMP</span><span class="p">(</span><span class="n">ASN1_Class_UNIVERSAL</span><span class="p">):</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;SNMP&quot;</span>
    <span class="n">PDU_GET</span> <span class="o">=</span> <span class="mh">0xa0</span>
    <span class="n">PDU_NEXT</span> <span class="o">=</span> <span class="mh">0xa1</span>
    <span class="n">PDU_RESPONSE</span> <span class="o">=</span> <span class="mh">0xa2</span>
    <span class="n">PDU_SET</span> <span class="o">=</span> <span class="mh">0xa3</span>
    <span class="n">PDU_TRAPv1</span> <span class="o">=</span> <span class="mh">0xa4</span>
    <span class="n">PDU_BULK</span> <span class="o">=</span> <span class="mh">0xa5</span>
    <span class="n">PDU_INFORM</span> <span class="o">=</span> <span class="mh">0xa6</span>
    <span class="n">PDU_TRAPv2</span> <span class="o">=</span> <span class="mh">0xa7</span>
</pre></div>
</div>
<p>These objects are PDU, and are in fact new names for a sequence container (this is generally the case for context objects: they are old containers with new names). This means creating the corresponding ASN.1 objects and BER codecs is simplistic:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ASN1_SNMP_PDU_GET</span><span class="p">(</span><span class="n">ASN1_SEQUENCE</span><span class="p">):</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">ASN1_Class_SNMP</span><span class="o">.</span><span class="n">PDU_GET</span>

<span class="k">class</span> <span class="nc">ASN1_SNMP_PDU_NEXT</span><span class="p">(</span><span class="n">ASN1_SEQUENCE</span><span class="p">):</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">ASN1_Class_SNMP</span><span class="o">.</span><span class="n">PDU_NEXT</span>

<span class="c1"># [...]</span>

<span class="k">class</span> <span class="nc">BERcodec_SNMP_PDU_GET</span><span class="p">(</span><span class="n">BERcodec_SEQUENCE</span><span class="p">):</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">ASN1_Class_SNMP</span><span class="o">.</span><span class="n">PDU_GET</span>

<span class="k">class</span> <span class="nc">BERcodec_SNMP_PDU_NEXT</span><span class="p">(</span><span class="n">BERcodec_SEQUENCE</span><span class="p">):</span>
    <span class="n">tag</span> <span class="o">=</span> <span class="n">ASN1_Class_SNMP</span><span class="o">.</span><span class="n">PDU_NEXT</span>

<span class="c1"># [...]</span>
</pre></div>
</div>
<p>Metaclasses provide the magic behind the fact that everything is automatically registered and that ASN.1 objects and BER codecs can find each other.</p>
<p>The ASN.1 fields are also trivial:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ASN1F_SNMP_PDU_GET</span><span class="p">(</span><span class="n">ASN1F_SEQUENCE</span><span class="p">):</span>
    <span class="n">ASN1_tag</span> <span class="o">=</span> <span class="n">ASN1_Class_SNMP</span><span class="o">.</span><span class="n">PDU_GET</span>

<span class="k">class</span> <span class="nc">ASN1F_SNMP_PDU_NEXT</span><span class="p">(</span><span class="n">ASN1F_SEQUENCE</span><span class="p">):</span>
    <span class="n">ASN1_tag</span> <span class="o">=</span> <span class="n">ASN1_Class_SNMP</span><span class="o">.</span><span class="n">PDU_NEXT</span>

<span class="c1"># [...]</span>
</pre></div>
</div>
<p>Now, the hard part, the ASN.1 packet:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">SNMP_error</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;no_error&quot;</span><span class="p">,</span>
               <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;too_big&quot;</span><span class="p">,</span>
<span class="c1"># [...]</span>
             <span class="p">}</span>

<span class="n">SNMP_trap_types</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;cold_start&quot;</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">:</span> <span class="s2">&quot;warm_start&quot;</span><span class="p">,</span>
<span class="c1"># [...]</span>
                  <span class="p">}</span>

<span class="k">class</span> <span class="nc">SNMPvarbind</span><span class="p">(</span><span class="n">ASN1_Packet</span><span class="p">):</span>
    <span class="n">ASN1_codec</span> <span class="o">=</span> <span class="n">ASN1_Codecs</span><span class="o">.</span><span class="n">BER</span>
    <span class="n">ASN1_root</span> <span class="o">=</span> <span class="n">ASN1F_SEQUENCE</span><span class="p">(</span> <span class="n">ASN1F_OID</span><span class="p">(</span><span class="s2">&quot;oid&quot;</span><span class="p">,</span><span class="s2">&quot;1.3&quot;</span><span class="p">),</span>
                                <span class="n">ASN1F_field</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span><span class="n">ASN1_NULL</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                                <span class="p">)</span>


<span class="k">class</span> <span class="nc">SNMPget</span><span class="p">(</span><span class="n">ASN1_Packet</span><span class="p">):</span>
    <span class="n">ASN1_codec</span> <span class="o">=</span> <span class="n">ASN1_Codecs</span><span class="o">.</span><span class="n">BER</span>
    <span class="n">ASN1_root</span> <span class="o">=</span> <span class="n">ASN1F_SNMP_PDU_GET</span><span class="p">(</span> <span class="n">ASN1F_INTEGER</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                                    <span class="n">ASN1F_enum_INTEGER</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">SNMP_error</span><span class="p">),</span>
                                    <span class="n">ASN1F_INTEGER</span><span class="p">(</span><span class="s2">&quot;error_index&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                                    <span class="n">ASN1F_SEQUENCE_OF</span><span class="p">(</span><span class="s2">&quot;varbindlist&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">SNMPvarbind</span><span class="p">)</span>
                                    <span class="p">)</span>

<span class="k">class</span> <span class="nc">SNMPnext</span><span class="p">(</span><span class="n">ASN1_Packet</span><span class="p">):</span>
    <span class="n">ASN1_codec</span> <span class="o">=</span> <span class="n">ASN1_Codecs</span><span class="o">.</span><span class="n">BER</span>
    <span class="n">ASN1_root</span> <span class="o">=</span> <span class="n">ASN1F_SNMP_PDU_NEXT</span><span class="p">(</span> <span class="n">ASN1F_INTEGER</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                                     <span class="n">ASN1F_enum_INTEGER</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="n">SNMP_error</span><span class="p">),</span>
                                     <span class="n">ASN1F_INTEGER</span><span class="p">(</span><span class="s2">&quot;error_index&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                                     <span class="n">ASN1F_SEQUENCE_OF</span><span class="p">(</span><span class="s2">&quot;varbindlist&quot;</span><span class="p">,</span> <span class="p">[],</span> <span class="n">SNMPvarbind</span><span class="p">)</span>
                                     <span class="p">)</span>
<span class="c1"># [...]</span>

<span class="k">class</span> <span class="nc">SNMP</span><span class="p">(</span><span class="n">ASN1_Packet</span><span class="p">):</span>
    <span class="n">ASN1_codec</span> <span class="o">=</span> <span class="n">ASN1_Codecs</span><span class="o">.</span><span class="n">BER</span>
    <span class="n">ASN1_root</span> <span class="o">=</span> <span class="n">ASN1F_SEQUENCE</span><span class="p">(</span>
        <span class="n">ASN1F_enum_INTEGER</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="s2">&quot;v2c&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="s2">&quot;v2&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="s2">&quot;v3&quot;</span><span class="p">}),</span>
        <span class="n">ASN1F_STRING</span><span class="p">(</span><span class="s2">&quot;community&quot;</span><span class="p">,</span><span class="s2">&quot;public&quot;</span><span class="p">),</span>
        <span class="n">ASN1F_CHOICE</span><span class="p">(</span><span class="s2">&quot;PDU&quot;</span><span class="p">,</span> <span class="n">SNMPget</span><span class="p">(),</span>
                     <span class="n">SNMPget</span><span class="p">,</span> <span class="n">SNMPnext</span><span class="p">,</span> <span class="n">SNMPresponse</span><span class="p">,</span> <span class="n">SNMPset</span><span class="p">,</span>
                     <span class="n">SNMPtrapv1</span><span class="p">,</span> <span class="n">SNMPbulk</span><span class="p">,</span> <span class="n">SNMPinform</span><span class="p">,</span> <span class="n">SNMPtrapv2</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">def</span> <span class="nf">answers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PDU</span><span class="p">,</span> <span class="n">SNMPresponse</span><span class="p">)</span>    <span class="ow">and</span>
                 <span class="p">(</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">PDU</span><span class="p">,</span> <span class="n">SNMPget</span><span class="p">)</span> <span class="ow">or</span>
                   <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">PDU</span><span class="p">,</span> <span class="n">SNMPnext</span><span class="p">)</span> <span class="ow">or</span>
                   <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">PDU</span><span class="p">,</span> <span class="n">SNMPset</span><span class="p">)</span>    <span class="p">)</span> <span class="ow">and</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">PDU</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">PDU</span><span class="o">.</span><span class="n">id</span> <span class="p">)</span>
<span class="c1"># [...]</span>
<span class="n">bind_layers</span><span class="p">(</span> <span class="n">UDP</span><span class="p">,</span> <span class="n">SNMP</span><span class="p">,</span> <span class="n">sport</span><span class="o">=</span><span class="mi">161</span><span class="p">)</span>
<span class="n">bind_layers</span><span class="p">(</span> <span class="n">UDP</span><span class="p">,</span> <span class="n">SNMP</span><span class="p">,</span> <span class="n">dport</span><span class="o">=</span><span class="mi">161</span><span class="p">)</span>
</pre></div>
</div>
<p>That wasn&#8217;t that much difficult. If you think that can&#8217;t be that short to implement SNMP encoding/decoding and that I may may have cut too much, just look at the complete source code.</p>
<p>Now, how to use it? As usual:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">=</span><span class="n">SNMP</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">PDU</span><span class="o">=</span><span class="n">SNMPget</span><span class="p">(</span><span class="n">varbindlist</span><span class="o">=</span><span class="p">[</span><span class="n">SNMPvarbind</span><span class="p">(</span><span class="n">oid</span><span class="o">=</span><span class="s2">&quot;1.2.3&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
<span class="gp">... </span>                                           <span class="n">SNMPvarbind</span><span class="p">(</span><span class="n">oid</span><span class="o">=</span><span class="s2">&quot;3.2.1&quot;</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span><span class="p">)]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="go">###[ SNMP ]###</span>
<span class="go">  version= v3</span>
<span class="go">  community= &#39;public&#39;</span>
<span class="go">  \PDU\</span>
<span class="go">   |###[ SNMPget ]###</span>
<span class="go">   |  id= 0</span>
<span class="go">   |  error= no_error</span>
<span class="go">   |  error_index= 0</span>
<span class="go">   |  \varbindlist\</span>
<span class="go">   |   |###[ SNMPvarbind ]###</span>
<span class="go">   |   |  oid= &#39;1.2.3&#39;</span>
<span class="go">   |   |  value= 5</span>
<span class="go">   |   |###[ SNMPvarbind ]###</span>
<span class="go">   |   |  oid= &#39;3.2.1&#39;</span>
<span class="go">   |   |  value= &#39;hello&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hexdump</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="go">0000   30 2E 02 01 03 04 06 70  75 62 6C 69 63 A0 21 02   0......public.!.</span>
<span class="go">0010   01 00 02 01 00 02 01 00  30 16 30 07 06 02 2A 03   ........0.0...*.</span>
<span class="go">0020   02 01 05 30 0B 06 02 7A  01 04 05 68 65 6C 6C 6F   ...0...z...hello</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">send</span><span class="p">(</span><span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="s2">&quot;1.2.3.4&quot;</span><span class="p">)</span><span class="o">/</span><span class="n">UDP</span><span class="p">()</span><span class="o">/</span><span class="n">SNMP</span><span class="p">())</span>
<span class="go">.</span>
<span class="go">Sent 1 packets.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">SNMP</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="go">###[ SNMP ]###</span>
<span class="go">  version= &lt;ASN1_INTEGER[3L]&gt;</span>
<span class="go">  community= &lt;ASN1_STRING[&#39;public&#39;]&gt;</span>
<span class="go">  \PDU\</span>
<span class="go">   |###[ SNMPget ]###</span>
<span class="go">   |  id= &lt;ASN1_INTEGER[0L]&gt;</span>
<span class="go">   |  error= &lt;ASN1_INTEGER[0L]&gt;</span>
<span class="go">   |  error_index= &lt;ASN1_INTEGER[0L]&gt;</span>
<span class="go">   |  \varbindlist\</span>
<span class="go">   |   |###[ SNMPvarbind ]###</span>
<span class="go">   |   |  oid= &lt;ASN1_OID[&#39;.1.2.3&#39;]&gt;</span>
<span class="go">   |   |  value= &lt;ASN1_INTEGER[5L]&gt;</span>
<span class="go">   |   |###[ SNMPvarbind ]###</span>
<span class="go">   |   |  oid= &lt;ASN1_OID[&#39;.3.2.1&#39;]&gt;</span>
<span class="go">   |   |  value= &lt;ASN1_STRING[&#39;hello&#39;]&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="resolving-oid-from-a-mib">
<h3>Resolving OID from a MIB<a class="headerlink" href="#resolving-oid-from-a-mib" title="Permalink to this headline">¶</a></h3>
<div class="section" id="about-oid-objects">
<h4>About OID objects<a class="headerlink" href="#about-oid-objects" title="Permalink to this headline">¶</a></h4>
<p>OID objects are created with an <code class="docutils literal"><span class="pre">ASN1_OID</span></code> class:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">o1</span><span class="o">=</span><span class="n">ASN1_OID</span><span class="p">(</span><span class="s2">&quot;2.5.29.10&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">o2</span><span class="o">=</span><span class="n">ASN1_OID</span><span class="p">(</span><span class="s2">&quot;1.2.840.113549.1.1.1&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">o1</span><span class="p">,</span><span class="n">o2</span>
<span class="go">(&lt;ASN1_OID[&#39;.2.5.29.10&#39;]&gt;, &lt;ASN1_OID[&#39;.1.2.840.113549.1.1.1&#39;]&gt;)</span>
</pre></div>
</div>
</div>
<div class="section" id="loading-a-mib">
<h4>Loading a MIB<a class="headerlink" href="#loading-a-mib" title="Permalink to this headline">¶</a></h4>
<p>Scapy can parse MIB files and become aware of a mapping between an OID and its name:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">load_mib</span><span class="p">(</span><span class="s2">&quot;mib/*&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">o1</span><span class="p">,</span><span class="n">o2</span>
<span class="go">(&lt;ASN1_OID[&#39;basicConstraints&#39;]&gt;, &lt;ASN1_OID[&#39;rsaEncryption&#39;]&gt;)</span>
</pre></div>
</div>
<p>The MIB files I&#8217;ve used are attached to this page.</p>
</div>
<div class="section" id="scapy-s-mib-database">
<h4>Scapy&#8217;s MIB database<a class="headerlink" href="#scapy-s-mib-database" title="Permalink to this headline">¶</a></h4>
<p>All MIB information is stored into the conf.mib object. This object can be used to find the OID of a name</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">conf</span><span class="o">.</span><span class="n">mib</span><span class="o">.</span><span class="n">sha1_with_rsa_signature</span>
<span class="go">&#39;1.2.840.113549.1.1.5&#39;</span>
</pre></div>
</div>
<p>or to resolve an OID:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">conf</span><span class="o">.</span><span class="n">mib</span><span class="o">.</span><span class="n">_oidname</span><span class="p">(</span><span class="s2">&quot;1.2.3.6.1.4.1.5&quot;</span><span class="p">)</span>
<span class="go">&#39;enterprises.5&#39;</span>
</pre></div>
</div>
<p>It is even possible to graph it:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">conf</span><span class="o">.</span><span class="n">mib</span><span class="o">.</span><span class="n">_make_graph</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="automata">
<h2>Automata<a class="headerlink" href="#automata" title="Permalink to this headline">¶</a></h2>
<p>Scapy enables you to easily create network automata. Scapy does not stick to a specific model like <a class="reference external" href="https://en.wikipedia.org/wiki/Moore_machine">Moore</a> or <a class="reference external" href="https://en.wikipedia.org/wiki/Mealy_machine">Mealy</a> automata. It provides a flexible way for you to choose your way to go.</p>
<p>An automaton in Scapy is deterministic. It has different states: a start state, some intermediate and some end and error states. There are transitions from one state to another. Transitions can be tied to specific conditions, the reception of a specific packet or a timeout. When a transition is taken, one or more actions can be run. An action can be bound to many transitions. Parameters can be passed from states to transitions and from transitions to states and actions.</p>
<p>From a programmer&#8217;s point of view, states, transitions and actions are methods from an automaton subclass. They are decorated to provide some meta-information needed in order for the automaton to work.</p>
<div class="section" id="first-example">
<h3>First example<a class="headerlink" href="#first-example" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s begin with a simple example. I take the convention to write states with capitals, but any valid Python syntax would work as well.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HelloWorld</span><span class="p">(</span><span class="n">Automaton</span><span class="p">):</span>
    <span class="nd">@ATMT.state</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">BEGIN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;State=BEGIN&quot;</span><span class="p">)</span>

    <span class="nd">@ATMT.condition</span><span class="p">(</span><span class="n">BEGIN</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wait_for_nothing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Wait for nothing...&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">END</span><span class="p">()</span>

    <span class="nd">@ATMT.action</span><span class="p">(</span><span class="n">wait_for_nothing</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">on_nothing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Action on &#39;nothing&#39; condition&quot;</span><span class="p">)</span>

    <span class="nd">@ATMT.state</span><span class="p">(</span><span class="n">final</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">END</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;State=END&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In this example, we can see 3 decorators:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">ATMT.state</span></code> is used to indicate that a method is a state, and that can
have initial, final and error optional arguments set to non-zero for special states.</li>
<li><code class="docutils literal"><span class="pre">ATMT.condition</span></code> indicates a method to be run when the automaton state
reaches the indicated state. The argument is the name of the method representing that state</li>
<li><code class="docutils literal"><span class="pre">ATMT.action</span></code> binds a method to a transition and is run when the transition is taken.</li>
</ul>
<p>Running this example gives the following result:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">=</span><span class="n">HelloWorld</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="go">State=BEGIN</span>
<span class="go">Wait for nothing...</span>
<span class="go">Action on &#39;nothing&#39; condition</span>
<span class="go">State=END</span>
</pre></div>
</div>
<p>This simple automaton can be described with the following graph:</p>
<img alt="_images/ATMT_HelloWorld.png" src="_images/ATMT_HelloWorld.png" />
<p>The graph can be automatically drawn from the code with:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">HelloWorld</span><span class="o">.</span><span class="n">graph</span><span class="p">()</span>
</pre></div>
</div>
<p>The graph can be saved to an image file using:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">HelloWorld</span><span class="o">.</span><span class="n">graph</span><span class="p">()</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;automaton.png&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="changing-states">
<h3>Changing states<a class="headerlink" href="#changing-states" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">ATMT.state</span></code> decorator transforms a method into a function that raises an exception. If you raise that exception, the automaton state will be changed. If the change occurs in a transition, actions bound to this transition will be called. The parameters given to the function replacing the method will be kept and finally delivered to the method. The exception has a method action_parameters that can be called before it is raised so that it will store parameters to be delivered to all actions bound to the current transition.</p>
<p>As an example, let&#8217;s consider the following state:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@ATMT.state</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">MY_STATE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param1</span><span class="p">,</span> <span class="n">param2</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;state=MY_STATE. param1=</span><span class="si">%r</span><span class="s2"> param2=</span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">param1</span><span class="p">,</span> <span class="n">param2</span><span class="p">))</span>
</pre></div>
</div>
<p>This state will be reached with the following code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@ATMT.receive_condition</span><span class="p">(</span><span class="n">ANOTHER_STATE</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">received_ICMP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ICMP</span> <span class="ow">in</span> <span class="n">pkt</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">MY_STATE</span><span class="p">(</span><span class="s2">&quot;got icmp&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="p">[</span><span class="n">ICMP</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
</pre></div>
</div>
<p>Let&#8217;s suppose we want to bind an action to this transition, that will also need some parameters:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@ATMT.action</span><span class="p">(</span><span class="n">received_ICMP</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">on_ICMP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">icmp_type</span><span class="p">,</span> <span class="n">icmp_code</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">retaliate</span><span class="p">(</span><span class="n">icmp_type</span><span class="p">,</span> <span class="n">icmp_code</span><span class="p">)</span>
</pre></div>
</div>
<p>The condition should become:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@ATMT.receive_condition</span><span class="p">(</span><span class="n">ANOTHER_STATE</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">received_ICMP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ICMP</span> <span class="ow">in</span> <span class="n">pkt</span><span class="p">:</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">MY_STATE</span><span class="p">(</span><span class="s2">&quot;got icmp&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="p">[</span><span class="n">ICMP</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">)</span><span class="o">.</span><span class="n">action_parameters</span><span class="p">(</span><span class="n">pkt</span><span class="p">[</span><span class="n">ICMP</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">pkt</span><span class="p">[</span><span class="n">ICMP</span><span class="p">]</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="real-example">
<h3>Real example<a class="headerlink" href="#real-example" title="Permalink to this headline">¶</a></h3>
<p>Here is a real example take from Scapy. It implements a TFTP client that can issue read requests.</p>
<img alt="_images/ATMT_TFTP_read.png" src="_images/ATMT_TFTP_read.png" />
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TFTP_read</span><span class="p">(</span><span class="n">Automaton</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">parse_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">server</span><span class="p">,</span> <span class="n">sport</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">69</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
        <span class="n">Automaton</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sport</span> <span class="o">=</span> <span class="n">sport</span>

    <span class="k">def</span> <span class="nf">master_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span> <span class="n">IP</span> <span class="ow">in</span> <span class="n">pkt</span> <span class="ow">and</span> <span class="n">pkt</span><span class="p">[</span><span class="n">IP</span><span class="p">]</span><span class="o">.</span><span class="n">src</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="ow">and</span> <span class="n">UDP</span> <span class="ow">in</span> <span class="n">pkt</span>
                 <span class="ow">and</span> <span class="n">pkt</span><span class="p">[</span><span class="n">UDP</span><span class="p">]</span><span class="o">.</span><span class="n">dport</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_tid</span>
                 <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_tid</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">pkt</span><span class="p">[</span><span class="n">UDP</span><span class="p">]</span><span class="o">.</span><span class="n">sport</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_tid</span><span class="p">)</span> <span class="p">)</span>

    <span class="c1"># BEGIN</span>
    <span class="nd">@ATMT.state</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">BEGIN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span><span class="o">=</span><span class="mi">512</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">my_tid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sport</span> <span class="ow">or</span> <span class="n">RandShort</span><span class="p">()</span><span class="o">.</span><span class="n">_fix</span><span class="p">()</span>
        <span class="n">bind_bottom_up</span><span class="p">(</span><span class="n">UDP</span><span class="p">,</span> <span class="n">TFTP</span><span class="p">,</span> <span class="n">dport</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">my_tid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_tid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">l3</span> <span class="o">=</span> <span class="n">IP</span><span class="p">(</span><span class="n">dst</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span><span class="o">/</span><span class="n">UDP</span><span class="p">(</span><span class="n">sport</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">my_tid</span><span class="p">,</span> <span class="n">dport</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">)</span><span class="o">/</span><span class="n">TFTP</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l3</span><span class="o">/</span><span class="n">TFTP_RRQ</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;octet&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_packet</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">awaiting</span><span class="o">=</span><span class="mi">1</span>

        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">WAITING</span><span class="p">()</span>

    <span class="c1"># WAITING</span>
    <span class="nd">@ATMT.state</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">WAITING</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@ATMT.receive_condition</span><span class="p">(</span><span class="n">WAITING</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">receive_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">TFTP_DATA</span> <span class="ow">in</span> <span class="n">pkt</span> <span class="ow">and</span> <span class="n">pkt</span><span class="p">[</span><span class="n">TFTP_DATA</span><span class="p">]</span><span class="o">.</span><span class="n">block</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">awaiting</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_tid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">server_tid</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">[</span><span class="n">UDP</span><span class="p">]</span><span class="o">.</span><span class="n">sport</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">l3</span><span class="p">[</span><span class="n">UDP</span><span class="p">]</span><span class="o">.</span><span class="n">dport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_tid</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECEIVING</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>
    <span class="nd">@ATMT.action</span><span class="p">(</span><span class="n">receive_data</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">send_ack</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_packet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l3</span> <span class="o">/</span> <span class="n">TFTP_ACK</span><span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">awaiting</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_packet</span><span class="p">)</span>

    <span class="nd">@ATMT.receive_condition</span><span class="p">(</span><span class="n">WAITING</span><span class="p">,</span> <span class="n">prio</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">receive_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">TFTP_ERROR</span> <span class="ow">in</span> <span class="n">pkt</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">ERROR</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>

    <span class="nd">@ATMT.timeout</span><span class="p">(</span><span class="n">WAITING</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">timeout_waiting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">WAITING</span><span class="p">()</span>
    <span class="nd">@ATMT.action</span><span class="p">(</span><span class="n">timeout_waiting</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">retransmit_last_packet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">last_packet</span><span class="p">)</span>

    <span class="c1"># RECEIVED</span>
    <span class="nd">@ATMT.state</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">RECEIVING</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
        <span class="n">recvd</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">[</span><span class="n">Raw</span><span class="p">]</span><span class="o">.</span><span class="n">load</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">+=</span> <span class="n">recvd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">awaiting</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">recvd</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">blocksize</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">WAITING</span><span class="p">()</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">END</span><span class="p">()</span>

    <span class="c1"># ERROR</span>
    <span class="nd">@ATMT.state</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ERROR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">pkt</span><span class="p">):</span>
        <span class="n">split_bottom_up</span><span class="p">(</span><span class="n">UDP</span><span class="p">,</span> <span class="n">TFTP</span><span class="p">,</span> <span class="n">dport</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">my_tid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pkt</span><span class="p">[</span><span class="n">TFTP_ERROR</span><span class="p">]</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>

    <span class="c1">#END</span>
    <span class="nd">@ATMT.state</span><span class="p">(</span><span class="n">final</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">END</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">split_bottom_up</span><span class="p">(</span><span class="n">UDP</span><span class="p">,</span> <span class="n">TFTP</span><span class="p">,</span> <span class="n">dport</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">my_tid</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">res</span>
</pre></div>
</div>
<p>It can be run like this, for instance:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">TFTP_read</span><span class="p">(</span><span class="s2">&quot;my_file&quot;</span><span class="p">,</span> <span class="s2">&quot;192.168.1.128&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="detailed-documentation">
<h3>Detailed documentation<a class="headerlink" href="#detailed-documentation" title="Permalink to this headline">¶</a></h3>
<div class="section" id="decorator-for-states">
<h4>Decorator for states<a class="headerlink" href="#decorator-for-states" title="Permalink to this headline">¶</a></h4>
<p>States are methods decorated by the result of the <code class="docutils literal"><span class="pre">ATMT.state</span></code> function. It can take 3 optional parameters: <code class="docutils literal"><span class="pre">initial</span></code>, <code class="docutils literal"><span class="pre">final</span></code> and <code class="docutils literal"><span class="pre">error</span></code>. The set to <code class="docutils literal"><span class="pre">True</span></code> indicates that the state is an initial, final or error state.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">Automaton</span><span class="p">):</span>
    <span class="nd">@ATMT.state</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">BEGIN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@ATMT.state</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">SOME_STATE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@ATMT.state</span><span class="p">(</span><span class="n">final</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">END</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Result of the automaton: 42&quot;</span>

    <span class="nd">@ATMT.state</span><span class="p">(</span><span class="n">error</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ERROR</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;Partial result, or explanation&quot;</span>
<span class="c1"># [...]</span>
</pre></div>
</div>
</div>
<div class="section" id="decorators-for-transitions">
<h4>Decorators for transitions<a class="headerlink" href="#decorators-for-transitions" title="Permalink to this headline">¶</a></h4>
<p>Transitions are methods decorated by the result of one of <code class="docutils literal"><span class="pre">ATMT.condition</span></code>, <code class="docutils literal"><span class="pre">ATMT.receive_condition</span></code>, <code class="docutils literal"><span class="pre">ATMT.timeout</span></code>. They all take as argument the state method they are related to. <code class="docutils literal"><span class="pre">ATMT.timeout</span></code> also have a mandatory <code class="docutils literal"><span class="pre">timeout</span></code> parameter to provide the timeout value in seconds. <code class="docutils literal"><span class="pre">ATMT.condition</span></code> and <code class="docutils literal"><span class="pre">ATMT.receive_condition</span></code> have an optional <code class="docutils literal"><span class="pre">prio</span></code> parameter so that the order in which conditions are evaluated can be forced. Default priority is 0. Transitions with the same priority level are called in an undetermined order.</p>
<p>When the automaton switches to a given state, the state&#8217;s method is executed. Then transitions methods are called at specific moments until one triggers a new state (something like <code class="docutils literal"><span class="pre">raise</span> <span class="pre">self.MY_NEW_STATE()</span></code>). First, right after the state&#8217;s method returns, the <code class="docutils literal"><span class="pre">ATMT.condition</span></code> decorated methods are run by growing prio. Then each time a packet is received and accepted by the master filter all <code class="docutils literal"><span class="pre">ATMT.receive_condition</span></code> decorated hods are called by growing prio. When a timeout is reached since the time we entered into the current space, the corresponding <code class="docutils literal"><span class="pre">ATMT.timeout</span></code> decorated method is called.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">Automaton</span><span class="p">):</span>
    <span class="nd">@ATMT.state</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">WAITING</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@ATMT.condition</span><span class="p">(</span><span class="n">WAITING</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">it_is_raining</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">have_umbrella</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">ERROR_WET</span><span class="p">()</span>

    <span class="nd">@ATMT.receive_condition</span><span class="p">(</span><span class="n">WAITING</span><span class="p">,</span> <span class="n">prio</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">it_is_ICMP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ICMP</span> <span class="ow">in</span> <span class="n">pkt</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECEIVED_ICMP</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>

    <span class="nd">@ATMT.receive_condition</span><span class="p">(</span><span class="n">WAITING</span><span class="p">,</span> <span class="n">prio</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">it_is_IP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkt</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">IP</span> <span class="ow">in</span> <span class="n">pkt</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">RECEIVED_IP</span><span class="p">(</span><span class="n">pkt</span><span class="p">)</span>

    <span class="nd">@ATMT.timeout</span><span class="p">(</span><span class="n">WAITING</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">waiting_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">ERROR_TIMEOUT</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="decorator-for-actions">
<h4>Decorator for actions<a class="headerlink" href="#decorator-for-actions" title="Permalink to this headline">¶</a></h4>
<p>Actions are methods that are decorated by the return of <code class="docutils literal"><span class="pre">ATMT.action</span></code> function. This function takes the transition method it is bound to as first parameter and an optionnal priority <code class="docutils literal"><span class="pre">prio</span></code> as a second parameter. Default priority is 0. An action method can be decorated many times to be bound to many transitions.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Example</span><span class="p">(</span><span class="n">Automaton</span><span class="p">):</span>
    <span class="nd">@ATMT.state</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">BEGIN</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@ATMT.state</span><span class="p">(</span><span class="n">final</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">END</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@ATMT.condition</span><span class="p">(</span><span class="n">BEGIN</span><span class="p">,</span> <span class="n">prio</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">maybe_go_to_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">END</span><span class="p">()</span>
    <span class="nd">@ATMT.condition</span><span class="p">(</span><span class="n">BEGIN</span><span class="p">,</span> <span class="n">prio</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">certainly_go_to_end</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">END</span><span class="p">()</span>

    <span class="nd">@ATMT.action</span><span class="p">(</span><span class="n">maybe_go_to_end</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">maybe_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;We are lucky...&quot;</span><span class="p">)</span>
    <span class="nd">@ATMT.action</span><span class="p">(</span><span class="n">certainly_go_to_end</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">certainly_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;We are not lucky...&quot;</span><span class="p">)</span>
    <span class="nd">@ATMT.action</span><span class="p">(</span><span class="n">maybe_go_to_end</span><span class="p">,</span> <span class="n">prio</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="nd">@ATMT.action</span><span class="p">(</span><span class="n">certainly_go_to_end</span><span class="p">,</span> <span class="n">prio</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">always_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;This wasn&#39;t luck!...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The two possible outputs are:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">=</span><span class="n">Example</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="go">We are not lucky...</span>
<span class="go">This wasn&#39;t luck!...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="go">We are lucky...</span>
<span class="go">This wasn&#39;t luck!...</span>
</pre></div>
</div>
</div>
<div class="section" id="methods-to-overload">
<h4>Methods to overload<a class="headerlink" href="#methods-to-overload" title="Permalink to this headline">¶</a></h4>
<p>Two methods are hooks to be overloaded:</p>
<ul class="simple">
<li>The <code class="docutils literal"><span class="pre">parse_args()</span></code> method is called with arguments given at <code class="docutils literal"><span class="pre">__init__()</span></code> and <code class="docutils literal"><span class="pre">run()</span></code>. Use that to parametrize the behaviour of your automaton.</li>
<li>The <code class="docutils literal"><span class="pre">master_filter()</span></code> method is called each time a packet is sniffed and decides if it is interesting for the automaton. When working on a specific protocol, this is where you will ensure the packet belongs to the connection you are being part of, so that you do not need to make all the sanity checks in each transition.</li>
</ul>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Advanced usage</a><ul>
<li><a class="reference internal" href="#asn-1-and-snmp">ASN.1 and SNMP</a><ul>
<li><a class="reference internal" href="#what-is-asn-1">What is ASN.1?</a></li>
<li><a class="reference internal" href="#scapy-and-asn-1">Scapy and ASN.1</a><ul>
<li><a class="reference internal" href="#asn-1-engine">ASN.1 engine</a></li>
<li><a class="reference internal" href="#encoding-engines">Encoding engines</a></li>
<li><a class="reference internal" href="#asn-1-layers">ASN.1 layers</a><ul>
<li><a class="reference internal" href="#asn-1-fields">ASN.1 fields</a></li>
<li><a class="reference internal" href="#asn-1-packets">ASN.1 packets</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#a-complete-example-snmp">A complete example: SNMP</a></li>
<li><a class="reference internal" href="#resolving-oid-from-a-mib">Resolving OID from a MIB</a><ul>
<li><a class="reference internal" href="#about-oid-objects">About OID objects</a></li>
<li><a class="reference internal" href="#loading-a-mib">Loading a MIB</a></li>
<li><a class="reference internal" href="#scapy-s-mib-database">Scapy&#8217;s MIB database</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#automata">Automata</a><ul>
<li><a class="reference internal" href="#first-example">First example</a></li>
<li><a class="reference internal" href="#changing-states">Changing states</a></li>
<li><a class="reference internal" href="#real-example">Real example</a></li>
<li><a class="reference internal" href="#detailed-documentation">Detailed documentation</a><ul>
<li><a class="reference internal" href="#decorator-for-states">Decorator for states</a></li>
<li><a class="reference internal" href="#decorators-for-transitions">Decorators for transitions</a></li>
<li><a class="reference internal" href="#decorator-for-actions">Decorator for actions</a></li>
<li><a class="reference internal" href="#methods-to-overload">Methods to overload</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="usage.html" title="previous chapter">Usage</a></li>
      <li>Next: <a href="extending.html" title="next chapter">Build your own tools</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/advanced_usage.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2008, 2009 Philippe Biondi and the Scapy community.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
      |
      <a href="_sources/advanced_usage.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>